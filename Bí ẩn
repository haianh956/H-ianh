import discord
from discord import app_commands
import json
import os

# ========= CONFIG =========
TOKEN = "YOUR_BOT_TOKEN"
GUILD_ID = 1447947946254532641
DATA_FILE = "keys.json"

intents = discord.Intents.default()
client = discord.Client(intents=intents)
tree = app_commands.CommandTree(client)
guild = discord.Object(id=GUILD_ID)

# ========= LOAD / SAVE =========
def load_keys():
    if not os.path.exists(DATA_FILE):
        with open(DATA_FILE, "w", encoding="utf-8") as f:
            json.dump({}, f)
    with open(DATA_FILE, "r", encoding="utf-8") as f:
        return json.load(f)

def save_keys(data):
    with open(DATA_FILE, "w", encoding="utf-8") as f:
        json.dump(data, f, indent=4)

# ========= READY =========
@client.event
async def on_ready():
    await tree.sync(guild=guild)
    print("âœ… Bot online | Commands synced")

# ========= ADD KEY =========
@tree.command(name="addkey", description="Add a redeem key (admin)", guild=guild)
async def addkey(interaction: discord.Interaction, key: str, reward: str):
    await interaction.response.defer(ephemeral=True)

    if not interaction.user.guild_permissions.administrator:
        return await interaction.followup.send("âŒ Admin only.")

    data = load_keys()

    if key in data:
        return await interaction.followup.send("âŒ Key already exists.")

    data[key] = {
        "reward": reward,
        "used": False,
        "user": None
    }

    save_keys(data)
    await interaction.followup.send(
        f"âœ… Key added\nğŸ”‘ `{key}`\nğŸ **{reward}**"
    )

# ========= REDEEM =========
@tree.command(name="redeem", description="Redeem a key", guild=guild)
async def redeem(interaction: discord.Interaction, key: str):
    await interaction.response.defer(ephemeral=True)

    data = load_keys()

    if key not in data:
        return await interaction.followup.send("âŒ Invalid key.")

    if data[key]["used"]:
        return await interaction.followup.send("âŒ Key already used.")

    data[key]["used"] = True
    data[key]["user"] = str(interaction.user.id)
    save_keys(data)

    try:
        await interaction.user.send(
            f"ğŸ‰ **REDEEM SUCCESS**\n\n"
            f"ğŸ”‘ Key: `{key}`\n"
            f"ğŸ Reward: **{data[key]['reward']}**"
        )
    except:
        pass

    await interaction.followup.send("âœ… Redeem successful. Check DM.")

# ========= LIST KEY =========
@tree.command(name="listkey", description="List all keys (admin)", guild=guild)
async def listkey(interaction: discord.Interaction):
    await interaction.response.defer(ephemeral=True)

    if not interaction.user.guild_permissions.administrator:
        return await interaction.followup.send("âŒ Admin only.")

    data = load_keys()

    if not data:
        return await interaction.followup.send("ğŸ“­ No keys found.")

    msg = "ğŸ“œ **KEY LIST**\n\n"
    for k, info in data.items():
        status = "USED âœ…" if info["used"] else "UNUSED âŒ"
        user = f"<@{info['user']}>" if info["user"] else "-"

        msg += (
            f"ğŸ”‘ `{k}`\n"
            f"ğŸ {info['reward']}\n"
            f"ğŸ“Œ {status}\n"
            f"ğŸ‘¤ {user}\n"
            f"â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n"
        )

    await interaction.followup.send(msg)

# ========= RUN =========
client.run(TOKEN)
