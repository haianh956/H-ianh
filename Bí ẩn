import discord
from discord import app_commands
import json
import os

# ========= CONFIG =========
TOKEN = "YOUR_BOT_TOKEN"
GUILD_ID = 1447947946254532641  # Your server ID
DATA_FILE = "keys.json"

intents = discord.Intents.default()
client = discord.Client(intents=intents)
tree = app_commands.CommandTree(client)
guild = discord.Object(id=GUILD_ID)

# ========= LOAD / SAVE =========
def load_keys():
    if not os.path.exists(DATA_FILE):
        with open(DATA_FILE, "w", encoding="utf-8") as f:
            json.dump({}, f)
    with open(DATA_FILE, "r", encoding="utf-8") as f:
        return json.load(f)

def save_keys(data):
    with open(DATA_FILE, "w", encoding="utf-8") as f:
        json.dump(data, f, indent=4)

# ========= READY =========
@client.event
async def on_ready():
    tree.clear_commands(guild=guild)
    await tree.sync(guild=guild)
    print("âœ… Bot is online | Guild commands synced")

# ========= ADD KEY (ADMIN) =========
@tree.command(name="addkey", description="Add a redeem key (admin)", guild=guild)
@app_commands.describe(
    key="Redeem key",
    reward="Reward for this key"
)
async def addkey(interaction: discord.Interaction, key: str, reward: str):
    await interaction.response.defer(ephemeral=True)

    if not interaction.user.guild_permissions.administrator:
        return await interaction.followup.send(
            "âŒ Only administrators can use this command."
        )

    data = load_keys()

    if key in data:
        return await interaction.followup.send(
            "âŒ This key already exists."
        )

    data[key] = {
        "reward": reward,
        "used": False,
        "user": None
    }

    save_keys(data)

    await interaction.followup.send(
        f"âœ… Key added successfully.\nğŸ”‘ Key: `{key}`\nğŸ Reward: **{reward}**"
    )

# ========= REDEEM =========
@tree.command(name="redeem", description="Redeem a key", guild=guild)
@app_commands.describe(
    key="Enter your redeem key"
)
async def redeem(interaction: discord.Interaction, key: str):
    await interaction.response.defer(ephemeral=True)

    data = load_keys()

    if key not in data:
        return await interaction.followup.send(
            "âŒ Invalid key."
        )

    if data[key]["used"]:
        return await interaction.followup.send(
            "âŒ This key has already been used."
        )

    data[key]["used"] = True
    data[key]["user"] = str(interaction.user.id)
    save_keys(data)

    # Send DM
    try:
        await interaction.user.send(
            f"ğŸ‰ **REDEEM SUCCESSFUL** ğŸ‰\n\n"
            f"ğŸ”‘ Key: `{key}`\n"
            f"ğŸ Reward: **{data[key]['reward']}**"
        )
    except:
        pass

    await interaction.followup.send(
        "âœ… Redeem successful! Please check your DMs ğŸ“©"
    )

# ========= LIST KEYS (ADMIN) =========
@tree.command(name="listkey", description="View all keys (admin)", guild=guild)
async def listkey(interaction: discord.Interaction):
    await interaction.response.defer(ephemeral=True)

    if not interaction.user.guild_permissions.administrator:
        return await interaction.followup.send(
            "âŒ Only administrators can use this command."
        )

    data = load_keys()

    if not data:
        return await interaction.followup.send(
            "ğŸ“­ No keys available."
        )

    msg = "ğŸ“œ **KEY LIST**\n\n"
    for key, info in data.items():
        status = "USED âœ…" if info["used"] else "UNUSED âŒ"
        user = f"<@{info['user']}>" if info["user"] else "â€”"

        msg += (
            f"ğŸ”‘ `{key}`\n"
            f"ğŸ Reward: {info['reward']}\n"
            f"ğŸ“Œ Status: {status}\n"
            f"ğŸ‘¤ User: {user}\n"
            f"â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n"
        )

    await interaction.followup.send(msg)

# ========= RUN =========
client.run(TOKEN)
